---
title: "Automated visual testing with Percy"
date: 2021-06-18T23:33:40+10:00
draft: false
---

# todo
- note to self: webdriver integrates with lighthouse, try that out
- add link to repo saying see the final code there

I shared my [last post]({{< ref "20210613_mouse" >}}) with some friends, and
soon found out that the images and videos didn't load on Safari. What better
time than to introduce an overly complicated automated testing process to catch
these problems in the future!

I first checked my site in [browserstack](https://www.browserstack.com/). Sure
enough, it didn't display correctly on any iPhones or Safari on MacOS.

I'd heard of [percy](https://percy.io/) before, but never used it. It takes
snapshots of your site, and provides a visual tool for comparing differences as
you make changes. Seems like a good way to make sure I don't break the site as
I inevitably try out new stuff.

# Running percy locally

## Using webdriver

Percy is just a visual comparison tool, not a testing framework. It supports
many frameworks, including [WebdriverIO](https://webdriver.io/) which I'm
familiar with, so let's start with that:

```sh
# initialise npm in my blog project (nooo! I didn't think it would happen so soon :( )
npm init
# add webdriver
npm install @wdio/cli
npx wdio init
# modify package.json to make the test script = wdio ./wdio.conf.js
# check it works:
npm test
```

All good. Now replace the example test `wdio` created with just opening a few
pages on my site running locally:

```js
const baseUrl = 'http://localhost:1313';

async function click(selector) {
  const elem = await $(selector);
  await elem.waitForDisplayed();
  await elem.click();
}

describe('stuff', () => {
  it('goto homepage', async () => {
    await browser.url(baseUrl);
  });

  it('goto blog', async () => {
    await browser.url(baseUrl);
    await click('=Blog');
  });
});
```

In one terminal:

```sh
hugo server
```

In another terminal:

```sh
npm test
```

OK. This should be enough to take a couple of snapshots with percy. Install it:

```sh
npm i @percy/cli @percy/webdriverio
```

Add a `percySnapshot` at the end of each test, then run:

```sh
export PERCY_TOKEN=my_secret_token
npx percy exec -- wdio ./wdio.conf.js
```


## Using percy CLI

I just saw that there's an easier process for static sites. Let's try that:

https://docs.percy.io/docs/snapshot-cli-command

```sh
# publish everything, including drafts
hugo -D
# snapshot all html files
npx percy snapshot public/
```

All my pages are new at this point, so there's no changes to compare:

<img
  src="/blog/20210618_percy/new_snapshot.png"
  alt="example of a new snapshot display on Percy's UI" />

I've just realised that the only browsers currently supported are Chrome, Edge
and Firefox. Derp. Ah well, I've come this far, let's get it running in GitHub.

```yml
name: Percy
on: [push]
jobs:
  snapshot:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: get Node.js
        uses: actions/setup-node@v1
        with:
          node-version: 12.x
      - run: npm ci
      # don't need to do a hugo build here - I do that locally, for now at least
      - run: npx percy snapshot public/
```

set mah token in github. repo -> settings -> secrets -> new secret. PERCY_TOKEN

# next steps
- run in CI
  - create github action
    - https://docs.percy.io/docs/github-actions
  - check out percy github integration
    - https://docs.percy.io/docs/getting-started
    - https://percy.io/7ec1e795/iamwoz/integrations
- actually fix things for safari


# References
- [percy: Getting started](https://docs.percy.io/docs/getting-started)
- [percy: WebdriverIO](https://docs.percy.io/docs/webdriverio)
