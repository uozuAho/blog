---
title: "Automated testing with Percy"
date: 2021-06-18T23:33:40+10:00
draft: true
---

# todo
- note to self: webdriver integrates with lighthouse, try that out
- add link to repo saying see the final code there

I shared my [last post]({{< ref "20210613_mouse" >}}) with some friends, and
soon found out that the images and videos didn't load on Safari. What better
time than to introduce an overly complicated automated testing process to catch
these problems in the future!

I first checked my site in [browserstack](https://www.browserstack.com/). Sure
enough, it didn't display correctly on any iPhones or Safari on MacOS.

I'd heard of [percy](https://percy.io/) before, but never used it. It takes
snapshots of your site, and provides a visual tool for comparing differences as
you make changes. Seems like a good way to make sure I don't break the site as
I inevitably try out new stuff.

# Running percy locally

Percy is just a visual comparison tool, not a testing framework. It supports
many frameworks, including [WebdriverIO](https://webdriver.io/) which I'm
familiar with, so let's start with that:

```sh
# initialise npm in my blog project (nooo! I didn't think it would happen so soon :( )
npm init
# add webdriver
npm install @wdio/cli
npx wdio init
# modify package.json to make the test script = wdio ./wdio.conf.js
# check it works:
npm test
```

All good. Now replace the example test `wdio` created with just opening a few
pages on my site running locally:

```js
const baseUrl = 'http://localhost:1313';

async function click(selector) {
  const elem = await $(selector);
  await elem.waitForDisplayed();
  await elem.click();
}

describe('stuff', () => {
  it('goto homepage', async () => {
    await browser.url(baseUrl);
  });

  it('goto blog', async () => {
    await browser.url(baseUrl);
    await click('=Blog');
  });
});
```

In one terminal:

```sh
hugo server
```

In another terminal:

```sh
npm test
```

OK. This should be enough to take a couple of snapshots with percy. Install it:

```sh
npm i @percy/cli @percy/webdriverio
```

Add a `percySnapshot` at the end of each test, then run:

```sh
export PERCY_TOKEN=my_secret_token
npx percy exec -- wdio ./wdio.conf.js
```

# next steps
- run in CI ... github? netlify?
  - check out percy github integration: https://percy.io/7ec1e795/iamwoz/integrations
- test on common browsers


# References
- [percy: Getting started](https://docs.percy.io/docs/getting-started)
- [percy: WebdriverIO](https://docs.percy.io/docs/webdriverio)
